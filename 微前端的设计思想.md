## å¾®å‰ç«¯çš„è®¾è®¡æ€æƒ³

# 1ã€å¼•å…¥ï¼šä»€ä¹ˆæ˜¯å¾®æœåŠ¡ï¼Ÿ

å¾®æœåŠ¡æ˜¯è¿‘å‡ å¹´åœ¨äº’è”ç½‘ä¸šç•Œå†…éå¸¸ğŸ”¥ çš„ä¸€ä¸ªè¯ï¼Œåœ¨ä¿ºä»¬å¤§å­¦æ²¸ç‚¹å·¥ä½œå®¤Javaç»„ä¹Ÿå·²ç»æœ‰Spring Cloudå¾®æœåŠ¡çš„å®è·µå…ˆä¾‹ï¼Œé‚£æˆ‘ä»¬ä½œä¸ºå‰ç«¯çš„è§’åº¦ï¼Œè¯¥æ€ä¹ˆç†è§£å¾®æœåŠ¡å‘¢ï¼Ÿ

å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªğŸŒ° ï¼š

ä¸€ä¸ªç³»ç»Ÿæœ‰PC Webç«¯ã€æ‰‹æœºH5ã€å’Œåå°ç®¡ç†ç³»ç»Ÿï¼Œé‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿçš„ç»“æ„å¤§æ¦‚å°±åƒè¿™æ ·ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/ndgH50E7pIqeAqs5VTLzY8zSZicFQDJHRwibNRYSvPibMZpA6zLOGD6HNhj9A26v7ej3gSI7Zu4XsF39W3A2FEDibA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)image.png

è¿™æ ·ä¼šé€ æˆä»€ä¹ˆé—®é¢˜å˜ï¼Ÿ

- å•ä½“æœåŠ¡ç«¯é¡¹ç›®è¿‡å¤§ï¼Œä¸åˆ©äº**å¿«é€Ÿä¸Šæ‰‹**å’Œ**æ‰“åŒ…ç¼–è¯‘**ï¼›
- ä¸åŒç³»ç»Ÿä¼šæœ‰ç›¸åŒçš„åŠŸèƒ½ç‚¹ï¼Œå¯¼è‡´**äº§ç”Ÿå¤§é‡é‡å¤çš„æ— æ„ä¹‰çš„æ¥å£**ï¼›
- **æ•°æ®åº“è®¾è®¡å¤æ‚**ã€‚

é‚£ä¹ˆå¾®æœåŠ¡åˆæ˜¯æ€ä¹ˆè§£å†³çš„å˜ï¼Ÿ

æ ¸å¿ƒå°±æ˜¯å°±æ˜¯å°†ç³»ç»Ÿæ‹†åˆ†æˆä¸åŒçš„æœåŠ¡ï¼Œé€šè¿‡ç½‘å…³å’Œcontrolleræ¥è¿›è¡Œç®€å•çš„æ§åˆ¶å’Œè°ƒç”¨ï¼Œå„æœåŠ¡åˆ†è€Œæ²»ä¹‹ã€äº’ä¸å½±å“ã€‚

æˆ‘ä»¬ç°åœ¨å†çœ‹ä¸€å“ˆæ–°çš„é¡¹ç›®ç»“æ„ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/ndgH50E7pIqeAqs5VTLzY8zSZicFQDJHR19OIfkI0uXCEQ8QAfBPmGoduXmicGibjx0jMeOtPSDkdQibAOvcibU0AQg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)image.png

é€šè¿‡æœåŠ¡çš„æ‹†åˆ†åï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ä¸æ˜¯æ›´åŠ æ¸…æ™°äº†ğŸ˜ ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Ÿ

> è¿™å’Œæˆ‘ä»¬æœ¬æ¬¡çš„ä¸»é¢˜ï¼Œå¾®å‰ç«¯æœ‰ä»€ä¹ˆå…³ç³»å—

å‰ç«¯çš„å¾®å‰ç«¯æ€æƒ³å…¶å®åŒæ ·æ¥è‡ªäºæ­¤ï¼š**é€šè¿‡æ‹†åˆ†æœåŠ¡ï¼Œå®ç°é€»è¾‘çš„è§£è€¦**ã€‚

# 2ã€å‰ç«¯å¾®æœåŠ¡è®¾è®¡

## 2.1 ä¸ºä»€ä¹ˆå‰ç«¯éœ€è¦å¾®æœåŠ¡ï¼Ÿ

å½“æˆ‘ä»¬createä¸€ä¸ªæ–°é¡¹ç›®åï¼Œæƒ³å¿…å„ä½éƒ½æœ‰ä»¥ä¸‹ä½“ä¼šï¼š

> å†™é¡¹ç›®çš„ç¬¬ä¸€å¤©ï¼šæ‰“åŒ… 20s

> å†™é¡¹ç›®çš„ä¸€å‘¨ï¼šæ‰“åŒ… 1min

> å†™é¡¹ç›®çš„ä¸€ä¸ªæœˆï¼šæ‰“åŒ… 5min

*ä¹‹å‰ä½“éªŒè¿‡å…¬å¸è€é¡¹ç›®ï¼Œä»£ç é‡éå¸¸å¤§ï¼Œå¯è¯»æ€§ä¸é«˜ï¼Œæ‰“åŒ…éœ€è¦10+åˆ†é’Ÿ*ã€‚

éšç€é¡¹ç›®ä½“é‡çš„å¢åŠ ï¼Œä¸€ä¸ªå·¨å¤§çš„å•ä½“åº”ç”¨æ˜¯éš¾ä»¥ç»´æŠ¤çš„ï¼Œä»è€Œå¯¼è‡´ï¼šå¼€å‘æ•ˆç‡ä½ã€ä¸Šçº¿å›°éš¾ç­‰ä¸€ç³»åˆ—é—®é¢˜ã€‚

## 2.2 å¾®å‰ç«¯çš„åº”ç”¨åœºæ™¯

å¯¹äºä¸€ä¸ªç®¡ç†ç³»ç»Ÿï¼Œå®ƒçš„é¡µé¢é€šå¸¸æ˜¯é•¿è¿™ä¸ªæ ·å­çš„ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/ndgH50E7pIqeAqs5VTLzY8zSZicFQDJHRuBk5uPswWneiansUXn5oU1qnrxtic3kVA4aOVHaOtqibQMYtNjHeT89ibw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)image.png

ä¾§è¾¹æ çš„æ¯ä¸€ä¸ªtabï¼Œä¸‹é¢å¯èƒ½è¿˜æœ‰è‹¥å¹²çš„äºŒçº§èŠ‚ç‚¹ç”šè‡³æ˜¯ä¸‰çº§èŠ‚ç‚¹ï¼Œä¹…è€Œä¹…ä¹‹ï¼Œè¿™æ ·çš„ä¸€ä¸ªç®¡ç†ç³»ç»Ÿï¼Œç»ˆç©¶ä¹Ÿä¼šåƒå‰é¢æåˆ°çš„æœåŠ¡ç«¯ä¸€æ ·ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚

å¦‚æœæˆ‘ä»¬ç”¨å¾®å‰ç«¯è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿ

æ¯ä¸€ä¸ª`tab`å°±æ˜¯ä¸€ä¸ªå­åº”ç”¨ï¼Œæœ‰è‡ªå·±çš„çŠ¶æ€ï¼›è‡ªå·±çš„ä½œç”¨åŸŸï¼›å¹¶ä¸”å•ç‹¬æ‰“åŒ…å‘å¸ƒã€‚åœ¨å…¨å±€å±‚é¢åªéœ€è¦ç”¨ä¸€ä¸ªä¸»åº”ç”¨ï¼ˆmasterï¼‰å°±å¯ä»¥å®ç°ç®¡ç†å’Œæ§åˆ¶ã€‚

ä¸€å¥è¯æ¥è®²å°±æ˜¯ï¼š**åº”ç”¨åˆ†å‘è·¯ç”±->è·¯ç”±åˆ†å‘åº”ç”¨ã€‚**

## 2.3 æ—©æœŸå¾®å‰ç«¯æ€è·¯â€”â€”iFrame

> Why not iframe ?

å¯¹äºè·¯ç”±åˆ†å‘åº”ç”¨è¿™ä»¶äº‹ï¼šæˆ‘ä»¬åªéœ€è¦é€šè¿‡iFrameå°±å¯ä»¥å®ç°äº†ï¼Œå½“ç‚¹å‡»ä¸åŒçš„tabæ—¶ï¼ŒviewåŒºåŸŸå±•ç¤ºçš„æ˜¯iFrameç»„ä»¶ï¼Œæ ¹æ®è·¯ç”±åŠ¨æ€çš„æ”¹å˜iframeçš„`src`å±æ€§ï¼Œé‚£ä¸æ˜¯so easyï¼Ÿ

**å®ƒçš„å¥½å¤„æœ‰å“ªäº›ï¼Ÿ**

- è‡ªå¸¦æ ·å¼
- æ²™ç›’æœºåˆ¶ï¼ˆç¯å¢ƒéš”ç¦»ï¼‰
- å‰ç«¯ä¹‹é—´å¯ä»¥ç›¸äº’ç‹¬ç«‹è¿è¡Œ

**é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆæ²¡æœ‰ä½¿ç”¨iFrameåšå¾®å‰ç«¯å‘¢ï¼Ÿ**

- CSSé—®é¢˜ï¼ˆè§†çª—å¤§å°ä¸åŒæ­¥ï¼‰
- å­åº”ç”¨é€šä¿¡ï¼ˆä½¿ç”¨postMessageå¹¶ä¸å‹å¥½ï¼‰
- ç»„ä»¶ä¸èƒ½å…±äº«
- ä½¿ç”¨åˆ›å»º iframeï¼Œå¯èƒ½ä¼šå¯¹æ€§èƒ½æˆ–è€…å†…å­˜é€ æˆå½±å“

å¾®å‰ç«¯çš„è®¾è®¡æ„æ€ï¼šä¸ä»…èƒ½ç»§æ‰¿iframeçš„ä¼˜ç‚¹ï¼Œåˆå¯ä»¥è§£å†³å®ƒçš„ä¸è¶³ã€‚

# 3ã€å¾®å‰ç«¯æ ¸å¿ƒé€»è¾‘

## 3.1 å­åº”ç”¨åŠ è½½ï¼ˆLoaderï¼‰

å…ˆæ¥çœ‹çœ‹å¾®å‰ç«¯çš„æµç¨‹ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/ndgH50E7pIqeAqs5VTLzY8zSZicFQDJHRxXkiaNQGJytP3ErQadqHhCKP9rH3UrwYiaIhLxWQ0icZPWfnDG5IGxMsQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)image.png

æˆ‘ä»¬å¯ä»¥è¾¾æˆçš„å…±è¯†æ˜¯ï¼š**éœ€è¦å…ˆåŠ è½½åŸºåº§ï¼ˆmasterï¼‰ï¼Œå†æŠŠé€‰æ‹©æƒäº¤ç»™ä¸»åº”ç”¨ï¼Œç”±ä¸»åº”ç”¨æ ¹æ®æ³¨å†Œè¿‡çš„å­åº”ç”¨æ¥æŠ‰æ‹©åŠ è½½è°ï¼Œå½“å­åº”ç”¨åŠ è½½æˆåŠŸåï¼Œå†ç”±vue-routeræˆ–react-routeræ¥æ ¹æ®è·¯ç”±æ¸²æŸ“ç»„ä»¶ã€‚**

### 3.1.1 æ³¨å†Œ

å¦‚æœç²¾ç®€ä»£ç é€»è¾‘ï¼Œåœ¨åŸºåº§ä¸­å®é™…ä¸Šåªéœ€è¦åšä¸‰ä»¶äº‹ï¼š

```
// å‡è®¾æˆ‘ä»¬çš„å¾®å‰ç«¯æ¡†æ¶å«hailuo

import Hailuo from './lib/index';



// 1. å£°æ˜å­åº”ç”¨

const routers = [

    {

        path: 'http://localhost:8081',

        activeWhen: '/subapp1'

    },

    {

        path: 'http://localhost:8082',

        activeWhen: '/subapp2'

    }

];



// 2. æ³¨å†Œå­åº”ç”¨

Hailuo.registerApps(routers);



// 3. è¿è¡Œå¾®å‰ç«¯

Hailuo.run();
```

æ³¨å†Œéå¸¸å¥½ç†è§£ï¼Œç”¨ä¸€ä¸ªæ•°ç»„ç»´æŠ¤æ‰€æœ‰å·²ç»æ³¨å†Œäº†çš„å­åº”ç”¨ï¼š

```
    registerApps(routers: Router[]) {

        (routers || []).forEach((r) => {

            this.Apps.push({

                entry: r.path,

                activeRule: (location) => (location.href.indexOf(r.activeWhen) !== -1)

            });

        });

    }
```

### 3.1.2 æ‹¦æˆª

æˆ‘ä»¬éœ€è¦é€šè¿‡æ‹¦æˆªæ³¨å†Œè·¯ç”±äº‹ä»¶ä»¥ä¿è¯ä¸»/å­åº”ç”¨çš„é€»è¾‘å¤„ç†æ—¶æœºã€‚

```
import Hailuo from ".";



// éœ€è¦æ‹¦æˆªçš„å®è·µ

const EVENTS_NAME = ['hashchange', 'popstate'];

// å®è·µæ”¶é›†

const EVENTS_STACKS = {

    hashchange: [],

    popstate: []

};



// åŸºåº§åˆ‡æ¢è·¯ç”±åçš„é€»è¾‘

const handleUrlRoute = (...args) => {

    // åŠ è½½å¯¹åº”çš„å­åº”ç”¨

    Hailuo.loadApp();

    // æ‰§è¡Œå­åº”ç”¨è·¯ç”±çš„æ–¹æ³•

    callAllEventListeners(...args);

};



export const patch = () => {

    // 1. å…ˆä¿è¯åŸºåº§çš„äº‹ä»¶ç›‘å¬è·¯ç”±çš„å˜åŒ–

    window.addEventListener('hashchange', handleUrlRoute);

    window.addEventListener('popstate', handleUrlRoute);



    // 2. é‡å†™addEventListenerå’ŒremoveEventListener

    // å½“é‡åˆ°è·¯ç”±äº‹ä»¶åï¼šæ”¶é›†åˆ°stackä¸­

    // å¦‚æœæ˜¯å…¶ä»–äº‹ä»¶ï¼šæ‰§è¡Œoriginaläº‹ä»¶ç›‘å¬æ–¹æ³•

    const originalAddEventListener = window.addEventListener;

    const originalRemoveEventListener = window.removeEventListener;



    window.addEventListener = (name, handler) => {

        if(name && EVENTS_NAME.includes(name) && typeof handler === "function") {

            EVENTS_STACKS[name].indexOf(handler) === -1 && EVENTS_STACKS[name].push(handler);

            return;

        }

        return originalAddEventListener.call(this, name, handler);

    };



    window.removeEventListener = (name, handler) => {

        if(name && EVENTS_NAME.includes(name) && typeof handler === "function") {

            EVENTS_STACKS[name].indexOf(handler) === -1 && 

            (EVENTS_STACKS[name] = EVENTS_STACKS[name].filter((fn) => (fn !== handler)));

            return;

        } 

        return originalRemoveEventListener.call(this, name, handler);

    };



    // æ‰‹åŠ¨ç»™pushStateå’ŒreplaceStateæ·»åŠ ä¸Šç›‘å¬è·¯ç”±å˜åŒ–çš„èƒ½åŠ›

    // æœ‰ç‚¹åƒvue2ä¸­æ•°ç»„çš„å˜å¼‚æ–¹æ³•

    const createPopStateEvent = (state: any, name: string) => {

        const evt = new PopStateEvent("popstate", { state });

        evt['trigger'] = name;

        return evt;

    };



    const patchUpdateState = (updateState: (data: any, title: string, url?: string)=>void, name: string) => {

        return function() {

            const before = window.location.href;

            updateState.apply(this, arguments);

            const after = window.location.href;

            if(before !== after) {

                handleUrlRoute(createPopStateEvent(window.history.state, name));

            }

        };

    }



    window.history.pushState = patchUpdateState(

        window.history.pushState,

        "pushState"

    );

    window.history.replaceState = patchUpdateState(

        window.history.replaceState,

        "replaceState"

    );

}
```

### 3.1.3 åŠ è½½

é€šè¿‡è·¯ç”±å¯ä»¥åŒ¹é…åˆ°ç¬¦åˆçš„å­åº”ç”¨åï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å°†å®ƒåŠ è½½åˆ°é¡µé¢å‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“SPAçš„htmlæ–‡ä»¶åªæ˜¯ä¸€ä¸ªç©ºæ¨¡æ¿ï¼Œå®è´¨æ˜¯é€šè¿‡jsé©±åŠ¨çš„é¡µé¢æ¸²æŸ“ï¼Œé‚£ä¹ˆæˆ‘ä»¬æŠŠæŸä¸€ä¸ªé¡µé¢çš„jsæ–‡ä»¶ï¼Œå…¨éƒ½å‰ªåˆ‡åˆ°å¦ä¸€ä¸ªhtmlçš„`<script>`æ ‡ç­¾ä¸­æ‰§è¡Œï¼Œå°±å®ç°äº†Aé¡µé¢åŠ è½½Bçš„é¡µé¢ã€‚

```
    async loadApp() {

        // åŠ è½½å¯¹åº”çš„å­åº”ç”¨

        const shouldMountApp = this.Apps.filter(this.isActive);

        const app = shouldMountApp[0];

        const subapp = document.getElementById('submodule');

        await fetchUrl(app.entry)

        // å°†htmlæ¸²æŸ“åˆ°ä¸»åº”ç”¨é‡Œ

        .then((text) => {

            subapp.innerHTML = text;

        });

        // æ‰§è¡Œ fetchåˆ°çš„js

        const res = await fetchScripts(subapp, app.entry);

        if(res.length) {

            execScript(res.reduce((t, c) => (t+c), ''));

        } 

    }
```

**Betterå®è·µ â€”â€”** ã€**html-entry**ã€‘

å®ƒæ˜¯ä¸€ä¸ªåŠ è½½å¹¶å¤„ç†htmlã€jsã€cssçš„åº“ã€‚

å®ƒä¸æ˜¯å»åŠ è½½ä¸€ä¸ªä¸ªçš„jsã€cssèµ„æºï¼Œè€Œæ˜¯å»åŠ è½½å¾®åº”ç”¨çš„å…¥å£htmlã€‚

- **ç¬¬ä¸€æ­¥** ï¼šå‘é€è¯·æ±‚ï¼Œè·å–å­åº”ç”¨å…¥å£HTMLã€‚
- **ç¬¬äºŒæ­¥** ï¼šå¤„ç†è¯¥htmlæ–‡æ¡£ï¼Œå»æ‰htmlã€headæ ‡ç­¾ï¼Œå¤„ç†é™æ€èµ„æºã€‚
- **ç¬¬ä¸‰æ­¥** ï¼šå¤„ç†sourceMapï¼›å¤„ç†jsæ²™ç®±ï¼›æ‰¾åˆ°å…¥å£jsã€‚
- **ç¬¬å››æ­¥** ï¼šè·å–å­åº”ç”¨providerå†…å®¹

åŒæ—¶ï¼Œçº¦æŸäº†å­åº”ç”¨æä¾›åŠ è½½å’Œé”€æ¯å‡½æ•°ï¼ˆè¿™ä¸ªç»“æ„æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼‰ï¼š

```
export function provider({ dom, basename, globalData }) {



    return {

        render() {

            ReactDOM.render(

                <App basename={basename} globalData={globalData} />,

                dom ? dom.querySelector('#root') : document.querySelector('#root')

            );

        },

        destroy({ dom }) {

            if (dom) {

                ReactDOM.unmountComponentAtNode(dom);

            }

        },

    };

}
```

## 3.2 æ²™ç®±ï¼ˆSandboxï¼‰

æ²™ç®±æ˜¯ä»€ä¹ˆï¼šä½ å¯ä»¥ç†è§£ä¸ºå¯¹ä½œç”¨åŸŸçš„ä¸€ç§æ¯”å–»ï¼Œåœ¨ä¸€ä¸ªæ²™ç®±å†…ï¼Œæˆ‘çš„ä»»ä½•æ“ä½œä¸ä¼šå¯¹å¤–ç•Œäº§ç”Ÿå½±å“ã€‚

> Why we need sandboxï¼Ÿ

å½“æˆ‘ä»¬é›†æˆäº†å¾ˆå¤šå­åº”ç”¨åˆ°ä¸€èµ·åï¼ŒåŠ¿å¿…ä¼šå‡ºç°å†²çªï¼Œå¦‚**å…¨å±€å˜é‡å†²çª**ã€**æ ·å¼å†²çª**ï¼Œè¿™äº›å†²çªå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨æ ·å¼å¼‚å¸¸ï¼Œç”šè‡³åŠŸèƒ½ä¸å¯ç”¨ã€‚æ‰€ä»¥æƒ³è®©å¾®å‰ç«¯è¾¾åˆ°ç”Ÿäº§å¯ç”¨çš„ç¨‹åº¦ï¼Œè®©æ¯ä¸ªå­åº”ç”¨ä¹‹é—´è¾¾åˆ°ä¸€å®šç¨‹åº¦éš”ç¦»çš„æ²™ç®±æœºåˆ¶æ˜¯å¿…ä¸å¯å°‘çš„ã€‚

å®ç°æ²™ç®±ï¼Œæœ€é‡è¦çš„æ˜¯ï¼š**æ§åˆ¶æ²™ç®±çš„å¼€å¯å’Œå…³é—­ã€‚**

### **3.2.1 å¿«ç…§æ²™ç®±**

åŸç†å°±æ˜¯è¿è¡Œåœ¨æŸä¸€ç¯å¢ƒAæ—¶ï¼Œæ‰“ä¸€ä¸ªå¿«ç…§ï¼Œå½“ä»åˆ«çš„ç¯å¢ƒBåˆ‡æ¢å›æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå¿«ç…§å°±å¯ä»¥ç«‹å³æ¢å¤ä¹‹å‰ç¯å¢ƒAæ—¶çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼š

```
// åˆ‡æ¢åˆ°ç¯å¢ƒA

window.a = 2;



// åˆ‡æ¢åˆ°ç¯å¢ƒB

window.a = 3;



// åˆ‡æ¢åˆ°ç¯å¢ƒA

console.log(a);    // 2
```

å®ç°æ€è·¯ï¼Œæˆ‘ä»¬å‡è®¾æœ‰Sandboxè¿™ä¸ªç±»ï¼š

```
class Sandbox {

    private original;

    private mutated;

    sandBoxActive: () => void;

    sandBoxDeactivate: () => void;

}
const sandbox = new Sandbox();

const code = "...";

sandbox.activate();

execScript(code);

sandbox.sandBoxDeactivate();
```

æ¥ç†ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ï¼š

1. åœ¨sandBoxActiveçš„æ—¶å€™ï¼ŒæŠŠå˜é‡å­˜åˆ°originalé‡Œï¼›
2. åœ¨sandBoxDeactivateçš„æ—¶å€™ï¼ŒæŠŠå½“å‰å˜é‡å’Œoriginalå¯¹æ¯”ï¼Œä¸åŒçš„å­˜åˆ°mutatedï¼ˆä¿å­˜äº†å¿«ç…§ï¼‰ï¼Œç„¶åæŠŠå˜é‡çš„çŠ¶æ€æ¢å¤åˆ°originalï¼›
3. å½“è¯¥æ²™ç®±å†æ¬¡è§¦å‘sandBoxActiveï¼Œå°±å¯ä»¥æŠŠmutatedçš„å˜é‡æ¢å¤åˆ°windowä¸Šï¼Œå®ç°æ²™ç®±çš„åˆ‡æ¢ã€‚

### **3.2.2 VMæ²™ç®±**

ç±»ä¼¼äºnodeä¸­çš„vmæ¨¡å—ï¼ˆå¯åœ¨ V8 è™šæ‹Ÿæœºä¸Šä¸‹æ–‡ä¸­ç¼–è¯‘å’Œè¿è¡Œä»£ç ï¼‰ï¼šhttp://nodejs.cn/api/vm.html#vm_vm_executing_javascript

å¿«ç…§æ²™ç®±çš„ç¼ºç‚¹æ˜¯**æ— æ³•åŒæ—¶æ”¯æŒå¤šä¸ªå®ä¾‹ã€‚** ä½†æ˜¯vmæ²™ç®±åˆ©ç”¨proxyå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

```
class SandBox {

    execScript(code: string) {

        const varBox = {};

        const fakeWindow = new Proxy(window, {

            get(target, key) {

                return varBox[key] || window[key];

            },

            set(target, key, value) {

                varBox[key] = value;

                return true;

            }

        })

        const fn = new Function('window', code);

        fn(fakeWindow);

    }

}



export default SandBox;



// å®ç°äº†éš”ç¦»

const sandbox = new Sandbox();

sandbox.execScript(code)ï¼›



const sandbox2 = new Sandbox();

sandbox2.execScript(code2)ï¼›



// map

varBox = {

    'aWindow': '...',

    'bWindow': '...'

}
```

æˆ‘ä»¬æŠŠå„ä¸ªå­åº”ç”¨çš„windowæ”¾åˆ°mapä¸­ï¼Œé€šè¿‡proxyä»£ç†ï¼Œå½“è®¿é—®æ—¶ï¼Œç›´æ¥å°±æ˜¯è®¿é—®åˆ°çš„å„ä¸ªå­åº”ç”¨çš„windowå¯¹è±¡ï¼›å¦‚æœæ²¡æœ‰ï¼Œæ¯”å¦‚ä½¿ç”¨window.addEventListenerï¼Œå°±ä¼šå»çœŸæ­£çš„windowä¸­å¯»æ‰¾ã€‚

### 3.2.3 CSSæ²™ç®±

- **å‰æï¼šwebpackåœ¨æ„å»ºçš„æ—¶å€™ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡appendChildå»æ·»åŠ styleæ ‡ç­¾åˆ°htmlé‡Œçš„**

è§£å†³æ–¹æ¡ˆï¼šåŠ«æŒappendChildï¼Œå¢åŠ namespaceã€‚

